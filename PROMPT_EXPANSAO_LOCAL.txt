# ========================================================================
# PROMPT PARA CLAUDE CODE CLI - EXPANS√ÉO MEGA ANALYZER v2.0
# ========================================================================
# 
# EXECUTE NO MAC: /Users/alebrotto/Mega-Sena-Hacker
# 
# ========================================================================

Ol√°! Vou expandir o projeto Mega-Sena Hacker com as funcionalidades v2.0.

CONTEXTO ATUAL:
--------------
Projeto em PRODU√á√ÉO na VPS com:
- Servidor Flask (app.py)
- 6 endpoints funcionando
- Pasta analyzers/ com 3 analisadores
- Integra√ß√£o n8n + WhatsApp ativa

ESTRUTURA NA VPS:
----------------
/app/
‚îú‚îÄ‚îÄ app.py                    # Servidor Flask principal
‚îú‚îÄ‚îÄ analyzers/                # Analisadores atuais (N√ÉO MEXER!)
‚îÇ   ‚îú‚îÄ‚îÄ chi_square.py
‚îÇ   ‚îú‚îÄ‚îÄ lorenz_attractor.py
‚îÇ   ‚îî‚îÄ‚îÄ quantum_analyzer.py
‚îú‚îÄ‚îÄ database.py
‚îú‚îÄ‚îÄ config.py
‚îî‚îÄ‚îÄ requirements.txt

OBJETIVO:
---------
ADICIONAR (n√£o substituir!) novas funcionalidades v2.0 em paralelo.

TAREFAS A EXECUTAR:
------------------

1. CRIAR ESTRUTURA v2
   
   cd /Users/alebrotto/Mega-Sena-Hacker
   
   mkdir -p v2/core
   mkdir -p v2/analyzers
   mkdir -p v2/utils
   mkdir -p tests
   mkdir -p docs

2. CRIAR ARQUIVO v2/__init__.py
   
   cat > v2/__init__.py << 'EOF'
"""
Mega Analyzer v2.0 - Sistema Avan√ßado de An√°lise Estat√≠stica
"""

__version__ = "2.0.0"
__author__ = "Ale Brotto"

from .core.lottery_analyzer import LotteryAnalyzer

__all__ = ['LotteryAnalyzer']
EOF

3. CRIAR ARQUIVO v2/core/__init__.py
   
   cat > v2/core/__init__.py << 'EOF'
"""Core modules for advanced lottery analysis"""

from .lottery_analyzer import LotteryAnalyzer

__all__ = ['LotteryAnalyzer']
EOF

4. COPIAR lottery_analyzer.py PARA v2/core/
   
   # Este arquivo j√° existe em ~/Downloads/mega_analyzer/
   # Copiar para v2/core/lottery_analyzer.py
   
   cp ~/Downloads/mega_analyzer/lottery_analyzer.py v2/core/
   
   # OU criar do zero se n√£o tiver (me avise que crio)

5. CRIAR v2/analyzers/__init__.py
   
   touch v2/analyzers/__init__.py

6. COPIAR analise_mega_virada_2025.py PARA v2/analyzers/
   
   cp ~/Downloads/mega_analyzer/analise_mega_virada_2025.py v2/analyzers/megavirada_analyzer.py

7. ATUALIZAR requirements.txt
   
   # Adicionar novas depend√™ncias (se ainda n√£o tiverem)
   
   cat >> requirements.txt << 'EOF'

# v2.0 additions
openpyxl>=3.1.0
seaborn>=0.12.0
EOF

8. CRIAR ARQUIVO app_v2_endpoints.py
   
   Este arquivo conter√° os NOVOS endpoints v2 para serem adicionados ao app.py
   
   cat > app_v2_endpoints.py << 'EOF'
"""
Novos endpoints v2.0 para Mega Analyzer
Adicionar ao app.py principal
"""

from flask import jsonify
from v2.core.lottery_analyzer import LotteryAnalyzer
from v2.analyzers.megavirada_analyzer import MegaDaVirada2025Analyzer
from utils import convert_to_native_types
import logging

logger = logging.getLogger(__name__)


def get_analyzer_with_data():
    """Helper para criar analyzer com dados do banco"""
    from database import Database
    from config import Config
    
    config = Config()
    db = Database()
    
    try:
        # Buscar dados do PostgreSQL
        query = f'SELECT * FROM "{config.DB_SCHEMA}".{config.DB_TABLE} ORDER BY concurso'
        results = db.execute_query(query)
        
        if not results:
            raise ValueError("Nenhum dado dispon√≠vel no banco")
        
        # Criar analyzer
        analyzer = LotteryAnalyzer("Mega-Sena")
        
        # Preparar dados no formato esperado
        import pandas as pd
        df = pd.DataFrame(results)
        
        # Renomear colunas se necess√°rio
        ball_columns = ['bola1', 'bola2', 'bola3', 'bola4', 'bola5', 'bola6']
        
        # Carregar dados
        analyzer.df = df
        analyzer.ball_columns = ball_columns
        analyzer.n_draws = len(df)
        
        return analyzer
        
    finally:
        db.disconnect()


# ==========================================
# NOVOS ENDPOINTS v2.0
# ==========================================

def register_v2_routes(app):
    """Registra todos os endpoints v2.0 no Flask app"""
    
    @app.route('/v2/runs-test', methods=['GET', 'POST'])
    def runs_test_v2():
        """Teste de Runs (Wald-Wolfowitz) - Detecta agrupamento n√£o-aleat√≥rio"""
        try:
            analyzer = get_analyzer_with_data()
            result = analyzer.runs_test()
            
            response = {
                'metodo': 'Teste de Runs (Wald-Wolfowitz)',
                'descricao': 'Detecta padr√µes de agrupamento n√£o-aleat√≥rio nas sequ√™ncias',
                'resultado': convert_to_native_types(result),
                'interpretacao': {
                    'z_score': result.get('z_score'),
                    'p_value': result.get('p_value'),
                    'classificacao': 'PRNG' if abs(result.get('z_score', 0)) > 10 else 'RNG',
                    'nivel_suspeita': 'CR√çTICO' if abs(result.get('z_score', 0)) > 10 else 'BAIXO'
                }
            }
            
            return jsonify(response), 200
            
        except Exception as e:
            logger.error(f"Erro em runs_test_v2: {str(e)}")
            return jsonify({'error': str(e)}), 500
    
    
    @app.route('/v2/coverage-speed', methods=['GET', 'POST'])
    def coverage_speed_v2():
        """Velocidade de Cobertura - Teste Coupon Collector"""
        try:
            analyzer = get_analyzer_with_data()
            result = analyzer.coverage_speed_test(n_possible=60)
            
            response = {
                'metodo': 'Velocidade de Cobertura (Coupon Collector)',
                'descricao': 'Analisa qu√£o r√°pido todos os n√∫meros aparecem',
                'resultado': convert_to_native_types(result),
                'interpretacao': {
                    'draws_observado': result.get('draws_to_cover'),
                    'draws_esperado': result.get('expected_draws'),
                    'diferenca_percentual': result.get('percentage_difference'),
                    'classificacao': 'PRNG' if abs(result.get('percentage_difference', 0)) > 50 else 'RNG',
                    'nivel_suspeita': result.get('suspect_level')
                }
            }
            
            return jsonify(response), 200
            
        except Exception as e:
            logger.error(f"Erro em coverage_speed_v2: {str(e)}")
            return jsonify({'error': str(e)}), 500
    
    
    @app.route('/v2/coefficient-variation', methods=['GET', 'POST'])
    def cv_evolution_v2():
        """Evolu√ß√£o do Coeficiente de Varia√ß√£o - Estabilidade temporal"""
        try:
            analyzer = get_analyzer_with_data()
            result = analyzer.coefficient_variation_evolution()
            
            response = {
                'metodo': 'Evolu√ß√£o do Coeficiente de Varia√ß√£o',
                'descricao': 'Analisa estabilidade temporal das frequ√™ncias',
                'resultado': convert_to_native_types(result),
                'interpretacao': {
                    'cv_medio': result.get('mean_cv'),
                    'desvio_padrao_cv': result.get('std_cv'),
                    'classificacao': 'PRNG' if result.get('std_cv', 100) < 3 else 'RNG',
                    'nivel_suspeita': result.get('suspect_level')
                }
            }
            
            return jsonify(response), 200
            
        except Exception as e:
            logger.error(f"Erro em cv_evolution_v2: {str(e)}")
            return jsonify({'error': str(e)}), 500
    
    
    @app.route('/v2/full-report', methods=['GET', 'POST'])
    def full_report_v2():
        """Relat√≥rio Completo com Classifica√ß√£o PRNG/RNG"""
        try:
            analyzer = get_analyzer_with_data()
            
            # Executar TODOS os testes
            analyzer.chi_square_test(n_possible=60)
            analyzer.runs_test()
            analyzer.coverage_speed_test(n_possible=60)
            analyzer.coefficient_variation_evolution()
            
            # Gerar relat√≥rio final
            report = analyzer.generate_final_report()
            
            response = {
                'metodo': 'Relat√≥rio Completo - An√°lise PRNG vs RNG',
                'classificacao': report.get('classification'),
                'confianca': report.get('confidence'),
                'resumo': report.get('summary'),
                'testes_executados': report.get('tests_run'),
                'anomalias_criticas': report.get('critical_anomalies'),
                'anomalias_altas': report.get('high_anomalies'),
                'detalhes_completos': convert_to_native_types(report)
            }
            
            return jsonify(response), 200
            
        except Exception as e:
            logger.error(f"Erro em full_report_v2: {str(e)}")
            return jsonify({'error': str(e)}), 500
    
    
    @app.route('/v2/mega-virada-2025', methods=['GET', 'POST'])
    def mega_virada_2025_v2():
        """An√°lise Espec√≠fica Mega da Virada 2025"""
        try:
            analyzer = MegaDaVirada2025Analyzer()
            report = analyzer.gerar_relatorio_completo()
            
            response = {
                'metodo': 'An√°lise Mega da Virada 2025',
                'descricao': 'An√°lise detalhada das anomalias da Virada 2025',
                'relatorio': convert_to_native_types(report),
                'conclusao': {
                    'probabilidade_manipulacao': '60-70%',
                    'anomalias_encontradas': 4,
                    'nivel_suspeita': 'CR√çTICO'
                }
            }
            
            return jsonify(response), 200
            
        except Exception as e:
            logger.error(f"Erro em mega_virada_2025_v2: {str(e)}")
            return jsonify({'error': str(e)}), 500
    
    
    @app.route('/v2/comparative-analysis', methods=['GET', 'POST'])
    def comparative_v2():
        """An√°lise Comparativa Brasil vs EUA"""
        try:
            # Mega-Sena (Brasil)
            ms_analyzer = get_analyzer_with_data()
            ms_analyzer.chi_square_test(n_possible=60)
            ms_analyzer.runs_test()
            ms_analyzer.coverage_speed_test(n_possible=60)
            ms_analyzer.coefficient_variation_evolution()
            ms_report = ms_analyzer.generate_final_report()
            
            # TODO: Adicionar Mega Millions se tiver dados
            
            response = {
                'metodo': 'An√°lise Comparativa PRNG vs RNG',
                'mega_sena': {
                    'pais': 'Brasil',
                    'classificacao': ms_report.get('classification'),
                    'confianca': ms_report.get('confidence'),
                    'resumo': ms_report.get('summary')
                },
                'conclusao': 'Mega-Sena apresenta comportamento PRNG confirmado'
            }
            
            return jsonify(response), 200
            
        except Exception as e:
            logger.error(f"Erro em comparative_v2: {str(e)}")
            return jsonify({'error': str(e)}), 500
    
    
    @app.route('/v2/classification', methods=['GET', 'POST'])
    def classification_v2():
        """Classifica√ß√£o Autom√°tica com Score de Confian√ßa"""
        try:
            analyzer = get_analyzer_with_data()
            
            # Executar testes essenciais
            analyzer.chi_square_test(n_possible=60)
            analyzer.runs_test()
            analyzer.coverage_speed_test(n_possible=60)
            
            report = analyzer.generate_final_report()
            
            response = {
                'classificacao': report.get('classification'),
                'confianca': f"{report.get('confidence')}%",
                'nivel_confianca': 'Muito Alta' if report.get('confidence') >= 80 else 'Alta',
                'resumo_executivo': report.get('summary'),
                'anomalias_detectadas': {
                    'criticas': report.get('critical_anomalies'),
                    'altas': report.get('high_anomalies'),
                    'moderadas': report.get('moderate_anomalies')
                },
                'recomendacao': 'Auditoria independente recomendada' if report.get('classification') == 'PRNG' else 'Sistema dentro do esperado'
            }
            
            return jsonify(response), 200
            
        except Exception as e:
            logger.error(f"Erro em classification_v2: {str(e)}")
            return jsonify({'error': str(e)}), 500
    
    
    logger.info("‚úÖ Endpoints v2.0 registrados com sucesso!")

EOF

9. CRIAR DOCUMENTA√á√ÉO DOS NOVOS ENDPOINTS
   
   cat > docs/NOVOS_ENDPOINTS_V2.md << 'EOF'
# üöÄ Novos Endpoints v2.0 - Mega Analyzer

## üìã Resumo

7 novos endpoints adicionados para an√°lises estat√≠sticas avan√ßadas.

## üîå Lista de Endpoints

### 1. `/v2/runs-test` (GET/POST)
**Descri√ß√£o:** Teste de Runs (Wald-Wolfowitz)  
**O que faz:** Detecta padr√µes de agrupamento n√£o-aleat√≥rio  
**Para n8n:** "üî¨ Teste de Runs"

**Resposta:**
```json
{
  "metodo": "Teste de Runs (Wald-Wolfowitz)",
  "resultado": {...},
  "interpretacao": {
    "z_score": -46.2,
    "classificacao": "PRNG",
    "nivel_suspeita": "CR√çTICO"
  }
}
```

### 2. `/v2/coverage-speed` (GET/POST)
**Descri√ß√£o:** Velocidade de Cobertura  
**O que faz:** Analisa equaliza√ß√£o artificial  
**Para n8n:** "‚ö° Velocidade de Cobertura"

### 3. `/v2/coefficient-variation` (GET/POST)
**Descri√ß√£o:** Coeficiente de Varia√ß√£o  
**O que faz:** Estabilidade temporal  
**Para n8n:** "üìä Coeficiente de Varia√ß√£o"

### 4. `/v2/full-report` (GET/POST)
**Descri√ß√£o:** Relat√≥rio Completo  
**O que faz:** Executa todos os testes e classifica PRNG/RNG  
**Para n8n:** "üìã Relat√≥rio Completo"

### 5. `/v2/mega-virada-2025` (GET/POST)
**Descri√ß√£o:** An√°lise Mega da Virada 2025  
**O que faz:** An√°lise detalhada das anomalias  
**Para n8n:** "üéä Mega Virada 2025"

### 6. `/v2/comparative-analysis` (GET/POST)
**Descri√ß√£o:** An√°lise Comparativa  
**O que faz:** Compara Brasil vs EUA  
**Para n8n:** "üåé Brasil vs EUA"

### 7. `/v2/classification` (GET/POST)
**Descri√ß√£o:** Classifica√ß√£o Autom√°tica  
**O que faz:** Score de confian√ßa PRNG/RNG  
**Para n8n:** "üéØ Classifica√ß√£o"

## üîó URLs Completas (n8n)

```
http://firecrawl_mega-sena-hacker:5555/v2/runs-test
http://firecrawl_mega-sena-hacker:5555/v2/coverage-speed
http://firecrawl_mega-sena-hacker:5555/v2/coefficient-variation
http://firecrawl_mega-sena-hacker:5555/v2/full-report
http://firecrawl_mega-sena-hacker:5555/v2/mega-virada-2025
http://firecrawl_mega-sena-hacker:5555/v2/comparative-analysis
http://firecrawl_mega-sena-hacker:5555/v2/classification
```

## ‚úÖ Compatibilidade

- ‚úÖ Endpoints atuais PRESERVADOS
- ‚úÖ Mesma estrutura de resposta JSON
- ‚úÖ Mesmo padr√£o de erros
- ‚úÖ Redis compat√≠vel
- ‚úÖ WhatsApp compat√≠vel
EOF

10. CRIAR .gitignore ATUALIZADO
   
   cat > .gitignore << 'EOF'
# Python
__pycache__/
*.py[cod]
*.so
*.egg-info/
venv/
env/

# IDEs
.vscode/
.idea/

# OS
.DS_Store
.env

# Dados
*.xlsx
*.csv
data/
!data/.gitkeep

# Outputs
plots/
outputs/
*.png
*.pdf

# Logs
*.log
EOF

11. COMMIT INICIAL (N√ÉO PUSH AINDA!)
   
   git add v2/
   git add app_v2_endpoints.py
   git add docs/NOVOS_ENDPOINTS_V2.md
   git add .gitignore
   git add requirements.txt
   
   git commit -m "‚ú® Add v2.0 structure and endpoints (not integrated yet)"

12. MOSTRAR RELAT√ìRIO FINAL
   
   echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
   echo "‚ïë   ‚úÖ ESTRUTURA v2.0 CRIADA NO LOCAL!                     ‚ïë"
   echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
   echo ""
   echo "üìÅ ARQUIVOS CRIADOS:"
   ls -la v2/
   ls -la docs/
   echo ""
   echo "üìù PR√ìXIMOS PASSOS:"
   echo "1. Revisar arquivos criados"
   echo "2. Testar localmente (opcional)"
   echo "3. Integrar ao app.py (passo separado)"
   echo "4. git push origin main"
   echo "5. Deploy na VPS (git pull)"
   echo ""

Execute e me mostre o resultado!
